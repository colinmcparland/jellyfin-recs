name: Build & Release

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore
        run: dotnet restore

      - name: Build
        run: dotnet build --configuration Release --no-restore

      - name: Upload build artifact
        if: github.event_name == 'push'
        uses: actions/upload-artifact@v4
        with:
          name: plugin-dll
          path: Jellyfin.Plugin.MusicDiscovery/bin/Release/net8.0/Jellyfin.Plugin.MusicDiscovery.dll

  release:
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Extract version from tag
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Set version in meta.json
        run: |
          jq --arg ver "${{ steps.version.outputs.version }}.0.0" \
            '.version = ($ver | split(".") | .[:4] | join("."))' \
            Jellyfin.Plugin.MusicDiscovery/meta.json > meta.tmp && mv meta.tmp Jellyfin.Plugin.MusicDiscovery/meta.json

      - name: Build Release
        run: |
          VERSION="${{ steps.version.outputs.version }}.0.0"
          # Normalize to 4-part version (e.g., 0.2 -> 0.2.0.0)
          VERSION=$(echo "$VERSION" | awk -F. '{printf "%s.%s.%s.%s", $1, $2, $3, $4}')
          dotnet build --configuration Release -p:AssemblyVersion="$VERSION" -p:FileVersion="$VERSION"

      - name: Create plugin zip
        run: |
          mkdir -p release
          cp Jellyfin.Plugin.MusicDiscovery/bin/Release/net8.0/Jellyfin.Plugin.MusicDiscovery.dll release/
          cp Jellyfin.Plugin.MusicDiscovery/meta.json release/
          cp Jellyfin.Plugin.MusicDiscovery/bin/Release/net8.0/logo.png release/
          cd release
          zip ../music-discovery_${{ steps.version.outputs.version }}.zip *

      - name: Compute checksum
        id: checksum
        run: echo "md5=$(md5sum music-discovery_${{ steps.version.outputs.version }}.zip | awk '{print $1}')" >> "$GITHUB_OUTPUT"

      - name: Update manifest.json
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          CHECKSUM="${{ steps.checksum.outputs.md5 }}"
          TIMESTAMP="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          SOURCE_URL="https://github.com/${{ github.repository }}/releases/download/v${VERSION}/music-discovery_${VERSION}.zip"

          # Use jq to add the new version entry (prepend to versions array)
          jq --arg ver "$VERSION" \
             --arg changelog "Release v${VERSION}" \
             --arg abi "10.10.0.0" \
             --arg url "$SOURCE_URL" \
             --arg md5 "$CHECKSUM" \
             --arg ts "$TIMESTAMP" \
             '.[0].versions = [{
                version: $ver,
                changelog: $changelog,
                targetAbi: $abi,
                sourceUrl: $url,
                checksum: $md5,
                timestamp: $ts
              }] + .[0].versions' manifest.json > manifest.tmp && mv manifest.tmp manifest.json

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: music-discovery_${{ steps.version.outputs.version }}.zip
          generate_release_notes: true

      - name: Commit updated manifest and meta.json
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add manifest.json Jellyfin.Plugin.MusicDiscovery/meta.json
          git commit -m "Update manifest.json and meta.json for v${{ steps.version.outputs.version }}"
          git push origin HEAD:main
